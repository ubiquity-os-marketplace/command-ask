name: "@ubiquity-os-marketplace/command-ask"

on:
  workflow_dispatch:
    inputs:
      stateId:
        description: "State Id"
      eventName:
        description: "Event Name"
      eventPayload:
        description: "Event Payload"
      settings:
        description: "Settings"
      authToken:
        description: "Auth Token"
      ubiquityKernelToken:
        description: "Kernel attestation token (optional)"
      ref:
        description: "Ref"
      signature:
        description: "Signature sent from the Kernel"
      command:
        description: "Command"

jobs:
  compute:
    name: "LLM Reply"
    runs-on: ubuntu-latest
    permissions: write-all
    environment: ${{ (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/')) && 'main' || 'development' }}

    steps:
      - name: Decompress event payload
        uses: ubiquity-os/compress-action@main
        id: eventPayload
        with:
          data: ${{ inputs.eventPayload }}
          mode: decompress

      - uses: actions/checkout@v5
        with:
          token: ${{ inputs.authToken }}
          repository: ${{ fromJson(steps.eventPayload.outputs.result).repository.full_name }}
          fetch-depth: 0
          persist-credentials: false

      - name: Run Claude Code
        uses: ubiquity-os/claude-code-action@main
        env:
          CUSTOM_EVENT_PAYLOAD: ${{ steps.eventPayload.outputs.result }}
          CUSTOM_EVENT_NAME: ${{ inputs.eventName }}
        with:
          mode: "tag"
          trigger_phrase: "(@UbiquityOS|@ubiquityos|/ask)"
          allowed_tools: "Bash(gh issue view:*),Bash(gh pr view:*)"
          github_token: ${{ inputs.authToken }}
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          # Optional: Specify model (defaults to Claude Sonnet 4, uncomment for Claude Opus 4)
          model: "claude-opus-4-20250514"
          additional_permissions: |
            actions: read
